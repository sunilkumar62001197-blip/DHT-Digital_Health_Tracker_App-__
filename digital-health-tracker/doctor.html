<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Doctor View - Health Report and PDF Export">
  <meta name="theme-color" content="#14b8a6">
  
  <title>Doctor View - Digital Health Tracker</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/images/icon-72x72.png">
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="gradient-background"></div>
  
  <nav class="navbar">
    <div class="nav-container">
      <a href="dashboard.html" class="nav-brand">üè• Health Tracker</a>
      <ul class="nav-links">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="summary.html" class="nav-link">Summary</a></li>
        <li><a href="doctor.html" class="nav-link active">Doctor View</a></li>
        <li><a href="settings.html" class="nav-link">Settings</a></li>
        <li><a href="about.html" class="nav-link">About</a></li>
      </ul>
    </div>
  </nav>
  
  <div class="page-wrapper">
    <div class="container">
      
      <div class="content-section">
        <div class="flex justify-between items-center">
          <div>
            <h1>üè• Medical Report</h1>
            <p style="color: var(--text-secondary);">Comprehensive health overview for clinical review</p>
          </div>
          <div class="flex gap-1">
            <button class="btn btn-outline" onclick="exportData()">üìä Export CSV</button>
            <button class="btn btn-primary" onclick="generatePDF()">üìÑ Generate PDF</button>
          </div>
        </div>
      </div>
      
      <!-- Patient Information -->
      <div class="content-section">
        <h2>Patient Information</h2>
        <div class="grid grid-cols-3">
          <div>
            <p style="color: var(--text-tertiary); font-size: 0.875rem;">Name</p>
            <p style="font-weight: 600;" id="patientName">--</p>
          </div>
          <div>
            <p style="color: var(--text-tertiary); font-size: 0.875rem;">Age</p>
            <p style="font-weight: 600;" id="patientAge">--</p>
          </div>
          <div>
            <p style="color: var(--text-tertiary); font-size: 0.875rem;">Email</p>
            <p style="font-weight: 600;" id="patientEmail">--</p>
          </div>
          <div>
            <p style="color: var(--text-tertiary); font-size: 0.875rem;">Height</p>
            <p style="font-weight: 600;" id="patientHeight">--</p>
          </div>
          <div>
            <p style="color: var(--text-tertiary); font-size: 0.875rem;">Weight</p>
            <p style="font-weight: 600;" id="patientWeight">--</p>
          </div>
          <div>
            <p style="color: var(--text-tertiary); font-size: 0.875rem;">Joined</p>
            <p style="font-weight: 600;" id="patientJoined">--</p>
          </div>
        </div>
      </div>
      
      <!-- Health Alerts/Flags -->
      <div class="content-section" id="alertsSection">
        <h2>üö® Health Alerts</h2>
        <div id="alertsList"></div>
      </div>
      
      <!-- Summary Statistics -->
      <div class="content-section">
        <h2>üìä Summary Statistics (Last 30 Days)</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Average Steps</div>
            <div class="stat-value" id="avgSteps">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Average Heart Rate</div>
            <div class="stat-value" id="avgHR">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Average Sleep</div>
            <div class="stat-value" id="avgSleep">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Average Water</div>
            <div class="stat-value" id="avgWater">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Average Calories</div>
            <div class="stat-value" id="avgCalories">--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Health Score</div>
            <div class="stat-value" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="avgHealthScore">--</div>
          </div>
        </div>
      </div>
      
      <!-- Recent Entries Table -->
      <div class="content-section">
        <h2>üìù Recent Health Entries</h2>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;" id="entriesTable">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="text-align: left; padding: 1rem; font-weight: 600;">Date</th>
                <th style="text-align: left; padding: 1rem; font-weight: 600;">Steps</th>
                <th style="text-align: left; padding: 1rem; font-weight: 600;">HR (bpm)</th>
                <th style="text-align: left; padding: 1rem; font-weight: 600;">Sleep (h)</th>
                <th style="text-align: left; padding: 1rem; font-weight: 600;">Water</th>
                <th style="text-align: left; padding: 1rem; font-weight: 600;">Calories</th>
                <th style="text-align: left; padding: 1rem; font-weight: 600;">Mood</th>
                <th style="text-align: left; padding: 1rem; font-weight: 600;">Notes</th>
              </tr>
            </thead>
            <tbody id="entriesTableBody">
              <tr><td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-tertiary);">No entries found</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/dashboard.js"></script>
  <script src="assets/js/export.js"></script>
  <script src="assets/js/main.js"></script>
  
  <script>
    let userData, entries, goals, stats;
    
    function initDoctorView() {
      // Load data
      userData = StorageManager.getUserProfile();
      if (!userData || !userData.name) {
        window.location.href = '/index.html';
        return;
      }
      
      entries = StorageManager.getLastNDays(30);
      goals = StorageManager.getGoals();
      
      // Display patient info
      document.getElementById('patientName').textContent = userData.name || '--';
      document.getElementById('patientAge').textContent = userData.age ? `${userData.age} years` : '--';
      document.getElementById('patientEmail').textContent = userData.email || '--';
      document.getElementById('patientHeight').textContent = userData.height ? `${userData.height} cm` : '--';
      document.getElementById('patientWeight').textContent = userData.weight ? `${userData.weight} kg` : '--';
      document.getElementById('patientJoined').textContent = userData.joinedDate ? new Date(userData.joinedDate).toLocaleDateString() : '--';
      
      // Calculate statistics
      stats = DashboardManager.calculateStats(entries);
      const healthScore = DashboardManager.calculateHealthScore(entries, goals);
      
      document.getElementById('avgSteps').textContent = Math.round(stats.avgSteps);
      document.getElementById('avgHR').textContent = `${Math.round(stats.avgHeartRate)} bpm`;
      document.getElementById('avgSleep').textContent = `${stats.avgSleep.toFixed(1)}h`;
      document.getElementById('avgWater').textContent = `${stats.avgWater.toFixed(1)} glasses`;
      document.getElementById('avgCalories').textContent = Math.round(stats.avgCalories);
      document.getElementById('avgHealthScore').textContent = `${healthScore}/100`;
      
      // Display health flags
      const flags = DashboardManager.detectHealthFlags(entries, goals);
      displayHealthFlags(flags);
      
      // Display entries table
      displayEntriesTable(entries);
    }
    
    function displayHealthFlags(flags) {
      const alertsList = document.getElementById('alertsList');
      
      if (flags.length === 0) {
        alertsList.innerHTML = '<div class="flag" style="background: rgba(34, 197, 94, 0.1); border-left-color: var(--success-color);"><div class="flag-icon">‚úÖ</div><div><strong>No health alerts</strong><p style="color: var(--text-secondary); margin: 0;">All metrics are within normal ranges.</p></div></div>';
        return;
      }
      
      alertsList.innerHTML = '';
      flags.forEach(flag => {
        const flagEl = document.createElement('div');
        flagEl.className = `flag ${flag.type}`;
        
        const icon = flag.type === 'danger' ? 'üö®' : '‚ö†Ô∏è';
        flagEl.innerHTML = `
          <div class="flag-icon">${icon}</div>
          <div>
            <strong>${flag.message}</strong>
            <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem;">Metric: ${flag.metric}</p>
          </div>
        `;
        
        alertsList.appendChild(flagEl);
      });
    }
    
    function displayEntriesTable(entries) {
      const tbody = document.getElementById('entriesTableBody');
      
      if (entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-tertiary);">No entries found</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      entries.slice(0, 20).forEach((entry, index) => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--border-color)';
        if (index % 2 === 0) {
          row.style.backgroundColor = 'var(--bg-tertiary)';
        }
        
        row.innerHTML = `
          <td style="padding: 0.75rem;">${new Date(entry.date).toLocaleDateString()}</td>
          <td style="padding: 0.75rem;">${entry.steps || 0}</td>
          <td style="padding: 0.75rem;">${entry.heartRate || '--'}</td>
          <td style="padding: 0.75rem;">${entry.sleep || 0}</td>
          <td style="padding: 0.75rem;">${entry.water || 0}</td>
          <td style="padding: 0.75rem;">${entry.calories || 0}</td>
          <td style="padding: 0.75rem; text-transform: capitalize;">${entry.mood || '--'}</td>
          <td style="padding: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${entry.notes || '--'}">${entry.notes || '--'}</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    async function generatePDF() {
      App.showToast('Generating PDF report...', 'info');
      
      const flags = DashboardManager.detectHealthFlags(entries, goals);
      const healthScore = DashboardManager.calculateHealthScore(entries, goals);
      
      const reportStats = {
        ...stats,
        healthScore,
        flags: flags.map(f => f.message)
      };
      
      const success = await ExportManager.downloadPDF(userData, entries, reportStats);
      
      if (success) {
        App.showToast('PDF report generated successfully! üìÑ', 'success');
      } else {
        App.showToast('Failed to generate PDF. Please ensure jsPDF is loaded.', 'error');
      }
    }
    
    function exportData() {
      const success = ExportManager.downloadCSV(entries);
      
      if (success) {
        App.showToast('CSV data exported successfully! üìä', 'success');
      } else {
        App.showToast('Failed to export data.', 'error');
      }
    }
    
    window.addEventListener('DOMContentLoaded', initDoctorView);
  </script>
</body>
</html>
